<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
</head>
<body>
    <h1>Chat Page</h1>

    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js" integrity="sha512-tE1z+95+lMCGwy+9PnKgUSIeHhvioC9lMlI7rLWU0Ps3XTdjRygLcy4mLuL0JAoK4TLdQEyP0yOl/9dMOqpH/Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const socket = io('/chat');
        const roomName = window.location.pathname.split('/').pop();
        let userType
        socket.emit('join', { room: roomName });
        console.log('Room Name:', roomName);
        fetchType()

        async function fetchType() {
            try {
                const response = await fetch('/profile/type');
                const data = await response.json();
                userType = data.type;
                console.log('User Type:', userType);
                return userType;
            } catch (error) {
                console.error('Error fetching data:', error);
                return 'unknown'
            }
        } 

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (message !== '') {
                socket.emit('chatMessage', { message, type: userType, room: roomName });
                messageInput.value = '';
            }
        }

        function appendMessage(message, senderType) {
            const chatBox = document.getElementById('chat-box');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${senderType}: ${message}`;
            chatBox.appendChild(messageElement);
        }

        function loadChatHistory(chatHistory) {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = ''; 
            chatHistory.forEach((entry) => {
                appendMessage(entry.message, entry.sender);
            });
        }

        socket.on('chatMessage', (data) => {
            appendMessage(data.message, data.sender);
        });

        socket.on('chatHistory', (chatHistory) => {
            loadChatHistory(chatHistory);
        });
    </script>

<div id="chat-box"></div>

<input type="text" id="message-input" placeholder="Type a message...">
<button onclick="sendMessage()">Send</button>
</body>
</html>
